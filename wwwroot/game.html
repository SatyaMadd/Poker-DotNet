<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #2e8b57;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            color: #fff;
            flex-direction: column;
        }
        .table {
            display: grid;
            gap: 20px;
            margin-bottom: 20px;
        }
        .player {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .cards {
            display: flex;
        }
        .card {
            width: 50px;
            height: 70px;
            background-color: white;
            color: black;
            border: 1px solid #000;
            margin: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .blank-card {
            width: 50px;
            height: 70px;
            background-color: gray;
            border: 1px solid #000;
            margin: 5px;
        }
        .center {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .hidden {
            display: none;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.11/signalr.min.js"></script>
</head>
<body>
    <div class="table" id="table">
        <div class="center">
            <h2>Community Cards</h2>
            <div class="cards" id="commCards"></div>
            <p>Pot: <span id="potValue"></span></p>
            <p>Round: <span id="roundValue"></span></p>
        </div>
    </div>
    <div id="playerActions">
        <h2>Player Actions</h2>
        <button id="checkButton" onclick="check()">Check</button>
        <button id="callButton" onclick="call()">Call</button>
        <button id="betButton" onclick="bet(document.getElementById('betAmountInput').value)">Bet</button>
        <input type="number" id="betAmountInput" placeholder="Bet Amount">
        <button id="foldButton" onclick="fold()">Fold</button>
        <button id="showCardsButton" onclick="showCards()">Show Cards</button>
        <button id="muckCardsButton" onclick="muckCards()">Muck Cards</button>
    </div>
    <button id="leaveButton" onclick="leave()">Leave</button>
    <div id="waitingPlayerList"></div>
    <script>
        function parseJwt(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            return JSON.parse(jsonPayload);
        };
        const token = localStorage.getItem('jwtToken');
        var username = parseJwt(token).sub;
        let queue = [];
        let isProcessing = false;

        async function processQueue() {
            if (isProcessing) return;
            isProcessing = true; 

            while (queue.length > 0) {
                await refresh();
                queue.shift();
            }

            isProcessing = false; 
        }

        const gameConnection = new signalR.HubConnectionBuilder()
            .withUrl("/gamehub", { accessTokenFactory: () => token })
            .build();
        const joinConnection = new signalR.HubConnectionBuilder()
            .withUrl("/joinhub", { accessTokenFactory: () => token })
            .build();
        gameConnection.start().catch(function (err) {
            return console.error(err.toString());
        });
        joinConnection.start().catch(function (err) {
            return console.error(err.toString());
        });
        gameConnection.on("Send", function (action) {
            console.log("Received Send event");
            if(action.actionName == "DeleteGame"){
                window.location.href = '/join';
            }
        });
        gameConnection.on("Refresh", function () {
            queue.push(true);
            processQueue();
        });
        joinConnection.on("WaitingRoomRefresh", async function () {
            await waitingRoomRefresh();
        });

        async function refresh() {
            console.log('Refreshing...');
            try {
                let response = await gameConnection.invoke("Refresh");

                const game = response.game;
                if(game == null){
                    window.location.href = '/join';
                }
                const players = response.players;
                const playerCards = response.playerCards;
                const allPlayerCards = response.allPlayerCards;

                console.log('Players:', players);
                console.log('Player Cards:', playerCards);
                console.log('All Player Cards:', allPlayerCards);

                const table = document.getElementById('table');
                table.innerHTML = `
                    <div class="center">
                        <h2>Community Cards</h2>
                        <div class="cards" id="commCards"></div>
                        <p>Pot: <span id="potValue"></span></p>
                        <p>Round: <span id="roundValue"></span></p>
                    </div>
                `;

                let gridTemplateAreas;
                switch (players.length) {
                    case 2:
                        gridTemplateAreas = `
                            "player3 player2 player4"
                            "player5 center player6"
                            "player7 player1 player8"
                        `;
                        break;
                    case 3:
                        gridTemplateAreas = `
                            "player2 player4 player3"
                            "player5 center player6"
                            "player7 player1 player8"
                        `;
                        break;
                    case 4:
                        gridTemplateAreas = `
                            "player7 player3 player8"
                            "player2 center player4"
                            "player5 player1 player6"
                        `;
                        break;
                    case 5:
                        gridTemplateAreas = `
                            "player6 player7 player8"
                            "player3 center player4"
                            "player2 player1 player5"
                        `;
                        break;
                    case 6:
                        gridTemplateAreas = `
                            "player3 player4 player5"
                            "player2 center player6"
                            "player7 layer1 player8"
                        `;
                        break;
                    case 7:
                        gridTemplateAreas = `
                            "player4 player8 player5"
                            "player3 center player6"
                            "player2 player1 player7"
                        `;
                        break;
                    case 8:
                        gridTemplateAreas = `
                            "player4 player5 player6"
                            "player3 center player7"
                            "player2 player1 player8"
                        `;
                        break;
                    default:
                        gridTemplateAreas = `
                            "player4 player5 player6"
                            "player3 center player7"
                            "player2 player1 player8"
                        `;
                }

                table.style.gridTemplateAreas = gridTemplateAreas;

                const positions = [
                    'player1', 'player2', 'player3', 'player4', 'player5', 'player6', 'player7', 'player8'
                ];

                players.forEach((player, index) => {
                    const playerElement = document.createElement('div');
                    playerElement.className = 'player';
                    playerElement.style.gridArea = positions[index];

                    if (player.username === username) {
                        playerElement.innerHTML = `
                            <div class="cards">
                                ${playerCards.map(card => `<div class="card">${card.cardNumber} ${card.suit}</div>`).join('')}
                            </div>
                            <div>${player.username}</div>
                            <div>Chips: ${player.chips}</div>
                        `;
                    } else {
                        playerElement.innerHTML = `
                            <div class="cards">
                                <div class="blank-card"></div>
                                <div class="blank-card"></div>
                            </div>
                            <div>${player.username}</div>
                            <div>Chips: ${player.chips}</div>
                        `;
                    }

                    table.appendChild(playerElement);
                });

                const commCards = document.getElementById('commCards');
                commCards.innerHTML = game.commCards.map(card => `<div class="card">${card.cardNumber} ${card.suit}</div>`).join('');

                document.getElementById('potValue').textContent = game.pot;
                document.getElementById('roundValue').textContent = game.round;

                const checkButton = document.getElementById('checkButton');
                const callButton = document.getElementById('callButton');
                const betButton = document.getElementById('betButton');
                const betInput = document.getElementById('betAmountInput');
                const foldButton = document.getElementById('foldButton');
                const showCardsButton = document.getElementById('showCardsButton');
                const muckCardsButton = document.getElementById('muckCardsButton');

                const isPlayerTurn = players.some(player => player.username === username && player.isTurn);
                const betHasOccurred = game.betHasOccurred;

                if (game.showdown) {
                    checkButton.classList.add('hidden');
                    callButton.classList.add('hidden');
                    betButton.classList.add('hidden');
                    betInput.classList.add('hidden');
                    foldButton.classList.add('hidden');
                    showCardsButton.classList.toggle('hidden', !isPlayerTurn);
                    muckCardsButton.classList.toggle('hidden', !isPlayerTurn);
                } else {
                    showCardsButton.classList.add('hidden');
                    muckCardsButton.classList.add('hidden');
                    checkButton.classList.toggle('hidden', !(isPlayerTurn && !betHasOccurred));
                    callButton.classList.toggle('hidden', !(isPlayerTurn && betHasOccurred));
                    betButton.classList.toggle('hidden', !isPlayerTurn);
                    betInput.classList.toggle('hidden', !isPlayerTurn);
                    foldButton.classList.toggle('hidden', !(isPlayerTurn && betHasOccurred));
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function waitingRoomRefresh() {
            joinConnection.invoke("GetWaitingRoomPlayers")
                .then(players => {
                    var playerList = document.getElementById('waitingPlayerList');
                    playerList.innerHTML = '';
                    players.forEach(player => {
                        var playerElement = document.createElement('div');
                        playerElement.textContent = player.username;
                        playerList.appendChild(playerElement);

                        var kickButton = document.createElement('button');
                        kickButton.textContent = 'Kick';
                        kickButton.onclick = () => waitingRoomKick(player.username);
                        playerElement.appendChild(kickButton);

                        var admitButton = document.createElement('button');
                        admitButton.textContent = 'Admit';
                        admitButton.onclick = () => admit(player.username);
                        playerElement.appendChild(admitButton);
                    });
                }).catch(error => {
                    console.error('Error fetching players:', error);
                });
        }

        function check() {
            gameConnection.invoke("Check")
                .catch(err => console.error(err.toString()));
        }
        function call() {
            gameConnection.invoke("Check")
                .catch(err => console.error(err.toString()));
        }
        function bet(amount) {
            gameConnection.invoke("Bet", parseInt(amount))
                .catch(err => console.error(err.toString()));
        }
        function fold() {
            gameConnection.invoke("Fold")
                .catch(err => console.error(err.toString()));
        }
        function leave() {
            gameConnection.invoke("Leave")
                .catch(err => console.error(err.toString()));
            window.location.href = '/join';
        }
        function showCards() {
            gameConnection.invoke("ShowCards")
                .catch(err => console.error(err.toString()));
        }
        function muckCards() {
            gameConnection.invoke("MuckCards")
                .catch(err => console.error(err.toString()));
        }
        function gameKick(username) {
            gameConnection.invoke("Kick", username)
                .catch(err => console.error(err.toString()));
        }
        function waitingRoomKick(username) {
            joinConnection.invoke("Kick", username)
                .catch(err => console.error(err.toString()));
        }
        function admit(username) {
            joinConnection.invoke("Admit", username)
                .catch(err => console.error(err.toString()));
        }
    </script>
</body>
</html>
